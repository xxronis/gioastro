---
import { drupal } from '../../lib/drupal';
import { cfImg, getImagesFromWork } from '../../lib/jsonapi-images';
import Layout from '../../layouts/Layout.astro';
import WorkDetail from '../../components/WorkDetail.astro';
import { parseMeta } from '../../lib/metatag';
import type { DrupalMetaTag } from '../../lib/metatag';

export const prerender = false;

type JsonApiDoc = { data: any; included?: any[] };

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const alias = `/work/${slug}`;
const route = await drupal.resolveAlias(alias);
if (!route || route?.entity?.type !== 'node') {
  return Astro.redirect('/404');
}

const nodeDoc = await drupal.api<JsonApiDoc>(
  `/node/work/${route.entity.uuid}`,
  { include: 'field_media,field_media.field_media_image', 'fields[node--work]': 'title,body,field_media,metatag' }
);

const node = nodeDoc.data;
const title = node?.attributes?.title ?? 'Work';
const body = node?.attributes?.body?.processed ?? '';
const images = getImagesFromWork(nodeDoc, drupal.baseUrl);
const meta = parseMeta((node?.attributes?.metatag ?? []) as DrupalMetaTag[]);

Astro.response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=300');
---

<Layout
  title={meta.title ?? title}
  description={meta.description}
  ogTitle={meta.ogTitle}
  ogDescription={meta.ogDescription}
  ogImage={meta.ogImage}
>
  <WorkDetail title={title} body={body} images={images} />
</Layout>
