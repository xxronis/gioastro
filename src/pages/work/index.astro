---
import '../../styles/global.css';
import Layout from '../../layouts/Layout.astro';
import { api } from '../../lib/drupal';
import { getImagesFromEntity } from '../../lib/jsonapi-images';

const drupalBase = import.meta.env.DRUPAL_BASE_URL || '';

const works = await api<{ data: any[]; included?: any[] }>(
  '/node/work',
  {
    sort: '-created',
    // 'page[limit]': '30',
    include: 'field_media,field_media.field_media_image',
    // keep response smaller; add fields here if you want
    'fields[node--work]': 'title,path,field_media',
  }
);
---

<Layout>
  <div class="container mx-auto w-[80%] py-8">
    <h1 class="text-4xl font-semibold mb-4">Work</h1>

    <ul class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {works.data.map((n) => {
        const images = getImagesFromEntity(n, works.included, drupalBase);
        const img = images[0];
        const alias = n.attributes?.path?.alias ?? `/node/${n.id}`;

        return (
          <li class="bg-white rounded-xl shadow overflow-hidden">
            <a class="block h-full" href={alias}>
              {img?.src && (
                <img
                  class="w-full h-48 object-cover"
                  src={img.src}
                  alt={img.alt ?? ''}
                  loading="lazy"
                />
              )}
              <div class="p-4">
                <div class="text-blue-600 hover:underline font-medium">
                  {n.attributes?.title}
                </div>
              </div>
            </a>
          </li>
        );
      })}
    </ul>
  </div>
</Layout>