---
import Layout from "../layouts/Layout.astro";
import { drupal } from "../lib/drupal";
import { getImagesFromEntity } from "../lib/jsonapi-images";

let drupalAbout: any | null = null;
let drupalError: string | null = null;
let images: { src: string; alt?: string; width?: number; height?: number }[] = [];

try {
    const byAlias = await drupal.api<{ data: any[]; included?: any[] }>("/node/page", {
        "page[limit]": "1",
        include: "field_media,field_media.field_media_image",
    });

    drupalAbout = byAlias.data?.[0] ?? null;
    images = getImagesFromEntity(drupalAbout, byAlias.included, drupal.baseUrl);
    // console.log("Fetched about page:", drupalAbout);
} catch (err) {
    drupalError = err instanceof Error ? err.message : String(err);
}

const node = drupalAbout;
const title = node?.attributes?.title ?? "About";
const body = node?.attributes?.body?.processed ?? "";
---

<Layout>
    <div class="py-8">
        <div class="container mx-auto w-[80%]">
            <div
                class="lg:pl-[8%] grid grid-cols-1 gap-10 lg:grid-cols-2 lg:items-start"
            >
                {/* LEFT: images */}
                {
                    images.map((img) => (
                        <div class="flex items-center justify-center">
                            <img
                                src={img.src}
                                alt={img.alt}
                                width={img.width}
                                height={img.height}
                                loading="lazy"
                                class="max-w-full max-h-full object-contain shadow"
                            />
                        </div>
                    ))
                }

                {/* RIGHT: details/content */}
                <div class="space-y-6 lg:border-l lg:pl-10">
                    <div>
                        <h1 class="mt-2 text-4xl font-semibold">{title}</h1>
                    </div>

                    <article class="prose prose-lg max-w-none">
                        <div set:html={body} />
                    </article>
                </div>
            </div>
        </div>
    </div>
</Layout>
