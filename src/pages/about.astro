---
import Layout from "../layouts/Layout.astro";
import { drupalClient } from "../lib/drupal";
import { requireEnv } from "../lib/env";
import { getImagesFromEntity, getImagesFromWork } from "../lib/jsonapi-images";

// TODO type DrupalNodePage = {
//     id: string;
//     attributes: {
//         title?: string;
//         body?: {
//             processed?: string;
//             value?: string;
//             summary?: string;
//         };
//         changed?: string;
//     };
// };

let drupalAbout: any | null = null;
let drupalError: string | null = null;
// Cloudflare SSR (when applicable):
const runtime = Astro.locals.runtime;
// Node dev/preview fallback:
const buildEnv = import.meta.env;

const env = requireEnv(runtime?.env ?? buildEnv);
const drupal = drupalClient(env);
let images: { src: string; alt?: string; width?: number; height?: number }[] = [];
try {
    const aboutAlias = "/about";

    const byAlias = await drupal.api<{ data: any[]; included?: any[] }>("/node/page", {
        "page[limit]": "1",
        // "filter[alias][condition][path]": "path.alias",
        // "filter[alias][condition][operator]": "=",
        // "filter[alias][condition][value]": aboutAlias,
        include: "field_media,field_media.field_media_image",
    });

    drupalAbout = byAlias.data?.[0] ?? null;
    images = getImagesFromEntity(
        drupalAbout,
        byAlias.included,
        env.DRUPAL_BASE_URL || "",
    );
    console.log("Fetched about page by alias:", drupalAbout);
    //   drupalAbout = res.data?.[0] ?? null;
} catch (err) {
    // Keep the page usable even when env vars aren't set or Drupal is unreachable.
    drupalError = err instanceof Error ? err.message : String(err);
}

const node = drupalAbout;
const title = node?.attributes?.title ?? "About";
const body = node?.attributes?.body?.processed ?? "";
const drupalBase = env.DRUPAL_BASE_URL || "";
---

<Layout>
    <div class="py-8">
        <div class="container mx-auto w-[80%]">
            <div
                class="lg:pl-[8%] grid grid-cols-1 gap-10 lg:grid-cols-2 lg:items-start"
            >
                {/* LEFT: images */}
                <!-- <div class="space-y-6"> -->
                {
                    images.map((img) => (
                        <div class="flex items-center justify-center">
                            <img
                                src={img.src}
                                alt={img.alt}
                                width={img.width}
                                height={img.height}
                                loading="lazy"
                                class="max-w-full max-h-full object-contain shadow"
                            />
                        </div>
                    ))
                }
                <!-- </div> -->

                {/* RIGHT: details/content */}
                <div class="space-y-6 lg:border-l lg:pl-10">
                    <div>
                        <h1 class="mt-2 text-4xl font-semibold">{title}</h1>
                    </div>

                    <article class="prose prose-lg max-w-none">
                        <div set:html={body} />
                    </article>
                </div>
            </div>
        </div>
    </div>

    <!-- 
  <main class="mx-auto max-w-3xl px-6 py-12">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold tracking-tight">About</h1>
      <p class="mt-3 text-base text-neutral-700">
        This is a starter About page. It renders static content first, and (optionally) enhances with content
        fetched server-side from Drupal JSON:API.
      </p>
    </header>

    <section class="space-y-4">
      <h2 class="text-xl font-semibold">Static content (starter)</h2>
      <p class="text-neutral-800">
        Use this section to quickly ship a page while the Drupal content model is still being set up.
        Once the CMS is ready, you can replace or augment this with content from Drupal.
      </p>
      <ul class="list-disc pl-6 text-neutral-800">
        <li>Astro v5 + Node adapter (server output)</li>
        <li>Tailwind for styling</li>
        <li>Drupal JSON:API for content</li>
      </ul>
    </section>

    <hr class="my-10 border-neutral-200" />

    <section class="space-y-4">
      <h2 class="text-xl font-semibold">From Drupal (optional)</h2>

      {drupalAbout ? (
        <article class="rounded-lg border border-neutral-200 bg-white p-6">
          <h3 class="text-lg font-semibold">{drupalAbout.attributes.title ?? "Untitled"}</h3>

          {drupalAbout.attributes.body?.processed ? (
            <div class="prose prose-neutral mt-4 max-w-none" set:html={drupalAbout.attributes.body.processed} />
          ) : (
            <p class="mt-4 text-neutral-700">No body content found on this page node.</p>
          )}

          {drupalAbout.attributes.changed ? (
            <p class="mt-6 text-sm text-neutral-500">
              Last updated: {new Date(drupalAbout.attributes.changed).toLocaleString()}
            </p>
          ) : null}
        </article>
      ) : (
        <div class="rounded-lg border border-dashed border-neutral-300 bg-neutral-50 p-6">
          <p class="text-neutral-700">Drupal content is not available yet{drupalError ? `: ${drupalError}` : "."}</p>
          <p class="mt-2 text-sm text-neutral-600">
            Set <code class="font-mono">DRUPAL_API_BASE</code> and ensure Drupal JSON:API is reachable to populate this
            section.
          </p>
        </div>
      )}
    </section>
  </main> -->
</Layout>
